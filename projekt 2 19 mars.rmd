---
title: "Projekt: 732G33: del 1"
output:
  html_document: default
  pdf_document: default
---

*Författare:* Jakob Eklund & Pelle Nyberg

*Liu-id:* jakek854 & pelny705

*Grupp:* 06


# Introduktion

För kommunaldata har vi hämtat data för variablerna medelålder, medelinkomst, 
andel utlandsfödda, andel moppar och även befolkning. 
För tiddserie har vi hämtat data för konsumentprisindex (KPI) på riksnivå i Sverige.
Tidsserien är på månadsnivå och innefattar perioden january 2012 till 
december 2021. Den innefattar en period om tio år och totalt 120 månader. Dessa
månader har konverterats till ett datumintervall i paketet lubridate. Datan för
KPI har konverterats så att den börjar med basen 100 där valt intervall börjar.
All använd data har hämtats från SCB.

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(pxweb)
library(lubridate)
library(data.table)
library(ggplot2)
```

```{r data.persons, echo=FALSE}
pxweb_query_list_persons <- 
    list("Region"=c("00","01","0114","0115","0117","0120","0123","0125","0126","0127","0128","0136","0138","0139","0140","0160","0162","0163","0180","0181","0182","0183","0184","0186","0187","0188","0191","0192","03","0305","0319","0330","0331","0360","0380","0381","0382","04","0428","0461","0480","0481","0482","0483","0484","0486","0488","05","0509","0512","0513","0560","0561","0562","0563","0580","0581","0582","0583","0584","0586","06","0604","0617","0642","0643","0662","0665","0680","0682","0683","0684","0685","0686","0687","07","0760","0761","0763","0764","0765","0767","0780","0781","08","0821","0834","0840","0860","0861","0862","0880","0881","0882","0883","0884","0885","09","0980","10","1060","1080","1081","1082","1083","12","1214","1230","1231","1233","1256","1257","1260","1261","1262","1263","1264","1265","1266","1267","1270","1272","1273","1275","1276","1277","1278","1280","1281","1282","1283","1284","1285","1286","1287","1290","1291","1292","1293","13","1315","1380","1381","1382","1383","1384","14","1401","1402","1407","1415","1419","1421","1427","1430","1435","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1452","1460","1461","1462","1463","1465","1466","1470","1471","1472","1473","1480","1481","1482","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493","1494","1495","1496","1497","1498","1499","17","1715","1730","1737","1760","1761","1762","1763","1764","1765","1766","1780","1781","1782","1783","1784","1785","18","1814","1860","1861","1862","1863","1864","1880","1881","1882","1883","1884","1885","19","1904","1907","1960","1961","1962","1980","1981","1982","1983","1984","20","2021","2023","2026","2029","2031","2034","2039","2061","2062","2080","2081","2082","2083","2084","2085","21","2101","2104","2121","2132","2161","2180","2181","2182","2183","2184","22","2260","2262","2280","2281","2282","2283","2284","23","2303","2305","2309","2313","2321","2326","2361","2380","24","2401","2403","2404","2409","2417","2418","2421","2422","2425","2460","2462","2463","2480","2481","2482","25","2505","2506","2510","2513","2514","2518","2521","2523","2560","2580","2581","2582","2583","2584"),
         "ContentsCode"=c("000000M5"),
         "Tid"=c("2021"))
  
  # Download data 
  px_data_persons <- 
    pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BE/BE0101/BE0101S/HushallT09",
              query = pxweb_query_list_persons)
  
  # Convert to data.frame 
  px_data_frame_persons <- as.data.frame(px_data_persons, column.name.type = "text", variable.value.type = "text")
  
  personPerHouse_Data <- px_data_frame_persons$`Antal personer per hushåll`
```

```{r data.befolkning, echo=FALSE}
  pxweb_query_list_befolkning <- 
    list("Region"=c("00","01","0114","0115","0117","0120","0123","0125","0126","0127","0128","0136","0138","0139","0140","0160","0162","0163","0180","0181","0182","0183","0184","0186","0187","0188","0191","0192","03","0305","0319","0330","0331","0360","0380","0381","0382","04","0428","0461","0480","0481","0482","0483","0484","0486","0488","05","0509","0512","0513","0560","0561","0562","0563","0580","0581","0582","0583","0584","0586","06","0604","0617","0642","0643","0662","0665","0680","0682","0683","0684","0685","0686","0687","07","0760","0761","0763","0764","0765","0767","0780","0781","08","0821","0834","0840","0860","0861","0862","0880","0881","0882","0883","0884","0885","09","0980","10","1060","1080","1081","1082","1083","12","1214","1230","1231","1233","1256","1257","1260","1261","1262","1263","1264","1265","1266","1267","1270","1272","1273","1275","1276","1277","1278","1280","1281","1282","1283","1284","1285","1286","1287","1290","1291","1292","1293","13","1315","1380","1381","1382","1383","1384","14","1401","1402","1407","1415","1419","1421","1427","1430","1435","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1452","1460","1461","1462","1463","1465","1466","1470","1471","1472","1473","1480","1481","1482","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493","1494","1495","1496","1497","1498","1499","17","1715","1730","1737","1760","1761","1762","1763","1764","1765","1766","1780","1781","1782","1783","1784","1785","18","1814","1860","1861","1862","1863","1864","1880","1881","1882","1883","1884","1885","19","1904","1907","1960","1961","1962","1980","1981","1982","1983","1984","20","2021","2023","2026","2029","2031","2034","2039","2061","2062","2080","2081","2082","2083","2084","2085","21","2101","2104","2121","2132","2161","2180","2181","2182","2183","2184","22","2260","2262","2280","2281","2282","2283","2284","23","2303","2305","2309","2313","2321","2326","2361","2380","24","2401","2403","2404","2409","2417","2418","2421","2422","2425","2460","2462","2463","2480","2481","2482","25","2505","2506","2510","2513","2514","2518","2521","2523","2560","2580","2581","2582","2583","2584"),
         "ContentsCode"=c("BE0101N1"),
         "Tid"=c("2021"))
  
  # Download data 
  px_data_befolkning <- 
    pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BE/BE0101/BE0101A/BefolkningNy",
              query = pxweb_query_list_befolkning)
  
  # Convert to data.frame 
  px_data_frame_befolkning <- as.data.frame(px_data_befolkning, column.name.type = "text", variable.value.type = "text")
  
  dataframemallen_befolkning <- data.frame(px_data_frame_befolkning$region, px_data_frame_befolkning$Folkmängd)

```

```{r data.age, echo=FALSE}
pxweb_query_list_age <- 
    list("Region"=c("00","01","0114","0115","0117","0120","0123","0125","0126","0127","0128","0136","0138","0139","0140","0160","0162","0163","0180","0181","0182","0183","0184","0186","0187","0188","0191","0192","03","0305","0319","0330","0331","0360","0380","0381","0382","04","0428","0461","0480","0481","0482","0483","0484","0486","0488","05","0509","0512","0513","0560","0561","0562","0563","0580","0581","0582","0583","0584","0586","06","0604","0617","0642","0643","0662","0665","0680","0682","0683","0684","0685","0686","0687","07","0760","0761","0763","0764","0765","0767","0780","0781","08","0821","0834","0840","0860","0861","0862","0880","0881","0882","0883","0884","0885","09","0980","10","1060","1080","1081","1082","1083","12","1214","1230","1231","1233","1256","1257","1260","1261","1262","1263","1264","1265","1266","1267","1270","1272","1273","1275","1276","1277","1278","1280","1281","1282","1283","1284","1285","1286","1287","1290","1291","1292","1293","13","1315","1380","1381","1382","1383","1384","14","1401","1402","1407","1415","1419","1421","1427","1430","1435","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1452","1460","1461","1462","1463","1465","1466","1470","1471","1472","1473","1480","1481","1482","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493","1494","1495","1496","1497","1498","1499","17","1715","1730","1737","1760","1761","1762","1763","1764","1765","1766","1780","1781","1782","1783","1784","1785","18","1814","1860","1861","1862","1863","1864","1880","1881","1882","1883","1884","1885","19","1904","1907","1960","1961","1962","1980","1981","1982","1983","1984","20","2021","2023","2026","2029","2031","2034","2039","2061","2062","2080","2081","2082","2083","2084","2085","21","2101","2104","2121","2132","2161","2180","2181","2182","2183","2184","22","2260","2262","2280","2281","2282","2283","2284","23","2303","2305","2309","2313","2321","2326","2361","2380","24","2401","2403","2404","2409","2417","2418","2421","2422","2425","2460","2462","2463","2480","2481","2482","25","2505","2506","2510","2513","2514","2518","2521","2523","2560","2580","2581","2582","2583","2584"),
         "ContentsCode"=c("BE0101G9"),
         "Tid"=c("2021"))
  
  # Download data 
  px_data_age <- 
    pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BE/BE0101/BE0101B/BefolkningMedelAlder", query = pxweb_query_list_age)
  
  # Convert to data.frame 
  px_data_frame_age <- as.data.frame(px_data_age, column.name.type = "text", variable.value.type = "text")
  
  result_age <- px_data_frame_age$`Befolkningens medelålder`

```

```{r data.foreign, echo=FALSE}
pxweb_query_list_foreign <- 
    list("Region"=c("00","01","0114","0115","0117","0120","0123","0125","0126","0127","0128","0136","0138","0139","0140","0160","0162","0163","0180","0181","0182","0183","0184","0186","0187","0188","0191","0192","03","0305","0319","0330","0331","0360","0380","0381","0382","04","0428","0461","0480","0481","0482","0483","0484","0486","0488","05","0509","0512","0513","0560","0561","0562","0563","0580","0581","0582","0583","0584","0586","06","0604","0617","0642","0643","0662","0665","0680","0682","0683","0684","0685","0686","0687","07","0760","0761","0763","0764","0765","0767","0780","0781","08","0821","0834","0840","0860","0861","0862","0880","0881","0882","0883","0884","0885","09","0980","10","1060","1080","1081","1082","1083","12","1214","1230","1231","1233","1256","1257","1260","1261","1262","1263","1264","1265","1266","1267","1270","1272","1273","1275","1276","1277","1278","1280","1281","1282","1283","1284","1285","1286","1287","1290","1291","1292","1293","13","1315","1380","1381","1382","1383","1384","14","1401","1402","1407","1415","1419","1421","1427","1430","1435","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1452","1460","1461","1462","1463","1465","1466","1470","1471","1472","1473","1480","1481","1482","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493","1494","1495","1496","1497","1498","1499","17","1715","1730","1737","1760","1761","1762","1763","1764","1765","1766","1780","1781","1782","1783","1784","1785","18","1814","1860","1861","1862","1863","1864","1880","1881","1882","1883","1884","1885","19","1904","1907","1960","1961","1962","1980","1981","1982","1983","1984","20","2021","2023","2026","2029","2031","2034","2039","2061","2062","2080","2081","2082","2083","2084","2085","21","2101","2104","2121","2132","2161","2180","2181","2182","2183","2184","22","2260","2262","2280","2281","2282","2283","2284","23","2303","2305","2309","2313","2321","2326","2361","2380","24","2401","2403","2404","2409","2417","2418","2421","2422","2425","2460","2462","2463","2480","2481","2482","25","2505","2506","2510","2513","2514","2518","2521","2523","2560","2580","2581","2582","2583","2584"),
         "UtlBakgrund"=c("08"),
         "ContentsCode"=c("000001NT"),
         "Tid"=c("2021"))
  
  # Download data 
  px_data_foreign <- 
    pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BE/BE0101/BE0101Q/UtlSvBakgFin",
              query = pxweb_query_list_foreign)
  
  # Convert to data.frame 
  px_data_frame_foreign <- as.data.frame(px_data_foreign, column.name.type = "text", variable.value.type = "text")
  
  antalUtland <- px_data_frame_foreign$`Antal personer`
  
  andelUtland <- antalUtland
```

```{r income.data, echo=FALSE}
pxweb_query_list_income <- 
    list("Region"=c("00","01","0114","0115","0117","0120","0123","0125","0126","0127","0128","0136","0138","0139","0140","0160","0162","0163","0180","0181","0182","0183","0184","0186","0187","0188","0191","0192","03","0305","0319","0330","0331","0360","0380","0381","0382","04","0428","0461","0480","0481","0482","0483","0484","0486","0488","05","0509","0512","0513","0560","0561","0562","0563","0580","0581","0582","0583","0584","0586","06","0604","0617","0642","0643","0662","0665","0680","0682","0683","0684","0685","0686","0687","07","0760","0761","0763","0764","0765","0767","0780","0781","08","0821","0834","0840","0860","0861","0862","0880","0881","0882","0883","0884","0885","09","0980","10","1060","1080","1081","1082","1083","12","1214","1230","1231","1233","1256","1257","1260","1261","1262","1263","1264","1265","1266","1267","1270","1272","1273","1275","1276","1277","1278","1280","1281","1282","1283","1284","1285","1286","1287","1290","1291","1292","1293","13","1315","1380","1381","1382","1383","1384","14","1401","1402","1407","1415","1419","1421","1427","1430","1435","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1452","1460","1461","1462","1463","1465","1466","1470","1471","1472","1473","1480","1481","1482","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493","1494","1495","1496","1497","1498","1499","17","1715","1730","1737","1760","1761","1762","1763","1764","1765","1766","1780","1781","1782","1783","1784","1785","18","1814","1860","1861","1862","1863","1864","1880","1881","1882","1883","1884","1885","19","1904","1907","1960","1961","1962","1980","1981","1982","1983","1984","20","2021","2023","2026","2029","2031","2034","2039","2061","2062","2080","2081","2082","2083","2084","2085","21","2101","2104","2121","2132","2161","2180","2181","2182","2183","2184","22","2260","2262","2280","2281","2282","2283","2284","23","2303","2305","2309","2313","2321","2326","2361","2380","24","2401","2403","2404","2409","2417","2418","2421","2422","2425","2460","2462","2463","2480","2481","2482","25","2505","2506","2510","2513","2514","2518","2521","2523","2560","2580","2581","2582","2583","2584"),
         "Alder"=c("18+"),
         "ContentsCode"=c("000006SW"),
         "Tid"=c("2021"))
  
  # Download data 
  px_data_income <- 
    pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/HE/HE0110/HE0110G/TabVX4bDispInkN",
              query = pxweb_query_list_income)
  
  # Convert to data.frame 
  px_data_frame_income <- as.data.frame(px_data_income, column.name.type = "text", variable.value.type = "text")
  
  AverageIncomePerHouse <- px_data_frame_income$Medelvärde
```

```{r moppar.data, echo=FALSE}
pxweb_query_list_moppar <- 
    list("Region"=c("00","01","03","04","05","06","07","08","09","10","12","13","14","15","16","17","18","19","20","21","22","23","24","25","0114","0115","0117","0120","0123","0125","0126","0127","0128","0136","0138","0139","0140","0160","0162","0163","0180","0181","0182","0183","0184","0186","0187","0188","0191","0192","0305","0319","0330","0331","0360","0380","0381","0382","0428","0461","0480","0481","0482","0483","0484","0486","0488","0509","0512","0513","0560","0561","0562","0563","0580","0581","0582","0583","0584","0586","0604","0617","0642","0643","0662","0665","0680","0682","0683","0684","0685","0686","0687","0760","0761","0763","0764","0765","0767","0780","0781","0821","0834","0840","0860","0861","0862","0880","0881","0882","0883","0884","0885","0980","1060","1080","1081","1082","1083","1214","1230","1231","1233","1256","1257","1260","1261","1262","1263","1264","1265","1266","1267","1270","1272","1273","1275","1276","1277","1278","1280","1281","1282","1283","1284","1285","1286","1287","1290","1291","1292","1293","1315","1380","1381","1382","1383","1384","1401","1402","1407","1415","1419","1421","1427","1430","1435","1438","1439","1440","1441","1442","1443","1444","1445","1446","1447","1452","1460","1461","1462","1463","1465","1466","1470","1471","1472","1473","1480","1481","1482","1484","1485","1486","1487","1488","1489","1490","1491","1492","1493","1494","1495","1496","1497","1498","1499","1715","1730","1737","1760","1761","1762","1763","1764","1765","1766","1780","1781","1782","1783","1784","1785","1814","1860","1861","1862","1863","1864","1880","1881","1882","1883","1884","1885","1904","1907","1917","1960","1961","1962","1980","1981","1982","1983","1984","2021","2023","2026","2029","2031","2034","2039","2061","2062","2080","2081","2082","2083","2084","2085","2101","2104","2121","2132","2161","2180","2181","2182","2183","2184","2260","2262","2280","2281","2282","2283","2284","2303","2305","2309","2313","2321","2326","2361","2380","2401","2403","2404","2409","2417","2418","2421","2422","2425","2460","2462","2463","2480","2481","2482","2505","2506","2510","2513","2514","2518","2521","2523","2560","2580","2581","2582","2583","2584"),
         "Fordonsslag"=c("50"),
         "ContentsCode"=c("TK1001AC"),
         "Tid"=c("2021"))
  
  # Download data 
  px_data_moppar <- 
    pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/TK/TK1001/TK1001A/FordonTrafik",
              query = pxweb_query_list_moppar)
  
  # Convert to data.frame 
  px_data_frame_moppar <- as.data.frame(px_data_moppar, column.name.type = "text", variable.value.type = "text")
  
  iTrafik <- px_data_frame_moppar[apply(px_data_frame_moppar!=0,1,all),]
```

```{r data.combine, echo=FALSE}
min_lista <- list(Region=px_data_frame_befolkning$region, Medelålder=px_data_frame_age$`Befolkningens medelålder`,  Inkomst=px_data_frame_income$Medelvärde, "Utlandsfödda"=100*antalUtland/px_data_frame_befolkning$Folkmängd, "Mopeder"=100*iTrafik$`Fordon i trafik`/px_data_frame_befolkning$Folkmängd, Befolkning=px_data_frame_befolkning$Folkmängd)
total_df <- data.frame(min_lista)
total_df <- total_df[-1,]
setDT(total_df)
```
# Kommundata
```{r kommuntabell, echo=FALSE}
knitr::kable(total_df[150:154,], caption="Tabell över variabler", digits = 3, format.args = list(big.mark = ",",
  scientific = FALSE))
```


I denna tabell har vi data för medelålder, medellön på årsbasis(tkr), antal utlandsfödda per 100 invånare, antal moppar per 100 invånare samt antalet invånare. Våra kommuner vi har användt oss av står i kolumnen "Kommun". Varje rad representerar en kommun.


```{r medel, echo=FALSE}
medel.age <- mean(total_df$Medelålder)
medel.utland <- mean(total_df$"Utlandsfödda")
medel.inkomst <- mean(total_df$Inkomst)
medel.moppar <- mean(total_df$"Mopeder")
medel.population <- mean(total_df$Befolkning)
medel.all <- c(medel.age, medel.inkomst, medel.utland, medel.moppar, medel.population)
```
```{r median, echo=FALSE}
median.age <- median(total_df$Medelålder)
median.inkomst <- median(total_df$Inkomst)
median.utland <- median(total_df$"Utlandsfödda")
median.moppar <- median(total_df$"Mopeder")
median.population <- median(total_df$Befolkning)
median.all <- c(median.age, median.inkomst, median.utland, median.moppar, median.population)
```
```{r standardavikelse, echo=FALSE}
standardavikelse.age <- sd(total_df$Medelålder)
standardavikelse.inkomst <- sd(total_df$Inkomst)
standardavikelse.utland <- sd(total_df$"Utlandsfödda")
standardavikelse.moppar <- sd(total_df$"Mopeder")
standardavikelse.population <-sd(total_df$Befolkning)
standardavikelse.all <- c(standardavikelse.age, standardavikelse.inkomst, standardavikelse.utland, standardavikelse.moppar, standardavikelse.population)
```
```{r minumum, echo=FALSE}
lowest.age <- min(total_df$Medelålder)
lowest.inkomst <- min(total_df$Inkomst)
lowest.utland <- min(total_df$"Utlandsfödda")
lowest.moppar <- min(total_df$"Mopeder")
lowest.population <-min(total_df$Befolkning)
lowest.all <- c(lowest.age, lowest.inkomst, lowest.utland, lowest.moppar, lowest.population)
```
```{r maximum, echo=FALSE}
highest.age <- max(total_df$Medelålder)
highest.inkomst <- max(total_df$Inkomst)
highest.utland <- max(total_df$"Utlandsfödda")
highest.moppar <- max(total_df$"Mopeder")
highest.population <-max(total_df$Befolkning)
highest.all <- c(highest.age, highest.inkomst, highest.utland, highest.moppar, highest.population)
```

```{r tabl2.combine, echo=FALSE}
names_table2 <- c("Medelålder", "Medelinkomst", "Utlandsfödda", "Moppar", "Befolkning")
list_table2 <- list(" "=names_table2,Medelvärde=medel.all, Median=median.all
                    , Standardavikelse=standardavikelse.all, Minumum=lowest.all,
                    Maximum=highest.all)
table2_dataframe<- data.frame(list_table2)
knitr::kable(table2_dataframe,caption = "Tabell över statistiska mått",digits = 3, format.args = list(big.mark = ",",
  scientific = FALSE))
```
Ovan visar en tabell våra 4 variabler samt befolknings-variabeln.
Tabllen visar dessa varibler samt vad medelvärdet,medianen, standardavikelsen,
minsta och största obeservationen av samtliga variabler. 
I denna tabell till skillnad från den ovanför så är representerar variablerna Sveriges samtliga regioner, inte enbart våra utvalda kommuner.

```{r histo.lines, echo=FALSE, warning=FALSE, message=FALSE}
age.hist <- ggplot(data=px_data_frame_age) + aes(x=px_data_frame_age$`Befolkningens medelålder`)
(age.hist + 
  geom_histogram(fill="blue", color="black") + 
  geom_vline(xintercept=c(quantile(px_data_frame_age$`Befolkningens medelålder`, prob=c(.25,.75)), median(px_data_frame_age$`Befolkningens medelålder`)), linetype=2, col="red") +
  ggtitle("Medelålder för kommuner") + labs(y="Frekvens", x="Medelålder") +  
  annotate("text", x=41.3, y=-1, label="Q1", angle=0, size=4, color="black") +  
  annotate("text", x=45.1, y=-1, label="Q3", angle=0, size=4, color="black") +  
  annotate("text", x=43, y=-1, label="Median", angle=0, size=4, color="black"))

```

Detta histogram representerar medelålder för de olika kommunernas befolkning.
Vi har röda vertikala linjer som representerar första och tredje kvartil, samt 
medianen. Det som kan sägas om datan är att den är någorlunda normalfördelad.



```{r inc.utland, echo=FALSE, message=FALSE}
per100 <- data.frame(px_data_frame_foreign$`Antal personer`/px_data_frame_befolkning$Folkmängd*100)
utland.income <- data.frame(per100, px_data_frame_income$`Medelvärde,  tkr`)
utland.income <- utland.income[-17,]
plotUtland.income <- ggplot(data = utland.income, 
                            aes(x = utland.income$px_data_frame_income..Medelvärde...tkr., 
                                y = utland.income$px_data_frame_foreign..Antal.personer..px_data_frame_befolkning.Folkmängd))

plotUtland.income + geom_point() + stat_smooth(method=lm, se=FALSE) + ggtitle("Scatterplot med regressionslinje. Utländsk bakgrund vs medelinkomst") + labs(y="Utländska", x="Medelinkomst")

```

Ovan har vi en scatterplot mellan två variabler. Medelinkomst på x-axeln och
andel personer med utländsk bakgrund. Med regressionslinjens positiva lutning
så skulle det kunna tolkas som att person med utländsk bakgrund har högre 
inkomst i medel. Lutning är däremot inte så brant så det skulle behövas mer data 
för att vidare undersöka sambandet. 


```{r kor, echo=FALSE, message=FALSE, warning=FALSE}
korrelation.incUt <- cor.test(x=per100$px_data_frame_foreign..Antal.personer..px_data_frame_befolkning.Folkmängd..., y=px_data_frame_income$`Medelvärde,  tkr`)
cor.df <- t(data.frame(
  "T-value" = "1.1965",
  "Df" = "310",
  "P-value" = "0.2324",
  "95% CI" = "-0.04356668 - 0.17750238",
  "Correlation" = "0.0678"))

kable(cor.df, align = "l", row.names = TRUE, style="html", caption="Tabell för korrelationstest")


```

 
<br/>
Vidare har vi en undersökning av korrelation mellan variablerna utlandsfödda och medelinkomster. Datan presenteras i tabell samt även en utskrift från testet. Från testet så kan det klargöras att korrelationen inte är 0. Den är däremot väldigt svag så svårt att säga även här om det finns en korrelation. Vi har i testet utgått från en nollhypotes att korrelation är lika med 0 och en alternativhypotes att korrelationen inte är 0. Detta test är gjort med en 5% signifikansnivå. Och då vi får ett p-värde som är större än detta. 0.2324>0.05. Så accepterar vi nollhypotesen att korrelationen är 0. Det 95% konfidensintervall för detta test ligger på -0.04356668 - 0.1775023.

# Datanalys av tidsseriedata

```{r kpiPlot, echo=FALSE, warning=FALSE}

pxweb_query_list <- 
    list("ContentsCode"=c("000004VU"),
         "Tid"=c("2012M01","2012M02","2012M03","2012M04","2012M05","2012M06","2012M07","2012M08","2012M09","2012M10","2012M11","2012M12","2013M01","2013M02","2013M03","2013M04","2013M05","2013M06","2013M07","2013M08","2013M09","2013M10","2013M11","2013M12","2014M01","2014M02","2014M03","2014M04","2014M05","2014M06","2014M07","2014M08","2014M09","2014M10","2014M11","2014M12","2015M01","2015M02","2015M03","2015M04","2015M05","2015M06","2015M07","2015M08","2015M09","2015M10","2015M11","2015M12","2016M01","2016M02","2016M03","2016M04","2016M05","2016M06","2016M07","2016M08","2016M09","2016M10","2016M11","2016M12","2017M01","2017M02","2017M03","2017M04","2017M05","2017M06","2017M07","2017M08","2017M09","2017M10","2017M11","2017M12","2018M01","2018M02","2018M03","2018M04","2018M05","2018M06","2018M07","2018M08","2018M09","2018M10","2018M11","2018M12","2019M01","2019M02","2019M03","2019M04","2019M05","2019M06","2019M07","2019M08","2019M09","2019M10","2019M11","2019M12","2020M01","2020M02","2020M03","2020M04","2020M05","2020M06","2020M07","2020M08","2020M09","2020M10","2020M11","2020M12","2021M01","2021M02","2021M03","2021M04","2021M05","2021M06","2021M07","2021M08","2021M09","2021M10","2021M11","2021M12"))
# Hämtar tidsseriedata från SCB. Perioden 2012-01-01>2021-12-31. 120 perioder.
  
px_data <-  pxweb_get(url = "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/PR/PR0101/PR0101A/KPItotM",
            query = pxweb_query_list)

# Konverterar till dataframen
px_data_frame <- as.data.frame(px_data, column.name.type = "text", variable.value.type = "text")
minaDatum <- seq(from=ymd("2012-01-01"),to=ymd("2021-12-31"), by="months")
# Skapar variablen minaDatum för en månadssekvens för perioden
px_data_frame$`KPI, fastställda tal` <- px_data_frame$`KPI, fastställda tal`/3.1185
# Sätter början på periodens KPI till basen 100
px_data_frame$datum <- minaDatum # skapar kolumnen datum i dataframen
Y <- px_data_frame$`KPI, fastställda tal`
Y.plot <- ggplot(data=px_data_frame, 
                 aes(x=datum, y=px_data_frame$`KPI, fastställda tal`)) + geom_line(color="blue") + labs(x="Tid", y="KPI")
Y.plot
# Skapar plot med tid på x-axeln och variabeln Y (KPI) på Y-axeln
```

En tidsserie över perioden 1 januari 2012 till 31 december 2021. Där data hämtas från SCB och perioden har justerats så att basåret är 2012.

```{r means, echo=FALSE, warning=FALSE}
gruppera <- list(rep(c("Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"), times=10))
month.average <- aggregate(x=px_data_frame, by=gruppera, FUN=mean)
month_means <- month.average[c(5, 4, 9, 1, 8, 7, 6, 2, 12, 11, 10, 3),]
month_means$datum <- NULL
month_means$månad <- NULL
colnames(month_means) <- c("Månad", "Medel KPI" )
kable(month_means, row.names = F, format = "html", table.attr = "style='width:30%;'")


```
<br/>
Tabell för medelvärden månadsvis för KPI. Perioden 2012-2021.



```{r means.plot, echo=FALSE, warning=FALSE}
plot.means <- ggplot(data=month_means, aes(y=month_means$`Medel KPI`, x=Månad, group=1))
plot.means +  geom_line(color="blue", lwd=1.5) + labs(y="KPI")

```

En plot för medelvärden för KPI. Med olika månaders medelvärden på X-axeln. Perioden 2012-2021. Det som går att utläsa från detta samt från tabellen är det faktum
att medelvärdet är som lägst i januari och högst i december månad. 



```{r boxplot.year, echo=FALSE, warning=FALSE}
years.df <- px_data_frame
years.df$månad <- NULL
years.df$datum <- NULL
years <- (rep(c("2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021"), each=12))
years.df$years <- years
#years.group <- aggregate(years.df, by=years, FUN=mean)

ggplot(data = years.df, aes(x = years, y = years.df$`KPI, fastställda tal`)) +
  geom_boxplot(aes(group = years), fill="grey", color="blue") +
  labs(x = "År", y = "KPI", title = "Boxplot. Data år 2012-2021") 


```

Boxplots för åren 2012-2021. Med månadsdata january till februari för varje år. Man ser här 
väldigt tydligt att KPI ökar över tid. Och det tycks vara så att intervallet för KPI varje år ökat. 

```{r z.plot, echo=FALSE, warning=FALSE}
month_means_sub <- rep(c(month_means$`Medel KPI`), times=10)
Z <- Y - month_means_sub
Z <- Z+(mean(Y))
z.tid.df <- data.frame(Z, minaDatum)
colnames(z.tid.df) <- c("KPI", "Tid")
plot.z.tid <- ggplot(data=z.tid.df, 
                 aes(x=Tid, y=KPI)) + geom_line(color="blue")
plot.z.tid + geom_line(aes(y=Y), color="red")
  

```

Linjeplot för jämförelse av KPI där månadsvariation tagits bort, Z (blå linje) mot 
KPI som inte har justerats, Y (röd linje). De tycks följa en någorlunda liknande trend. 
Inga större skillnader här. 




```{r smooth.plot, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data=px_data_frame, 
                 aes(x=datum, y=px_data_frame$`KPI, fastställda tal`)) + geom_line(color="blue") + geom_smooth(method="lm") + ylab("KPI")

```
Linjeplot för KPI under hela intervallet 2012-2021. Denna plot med en regressionslinje som tydligt har positiv lutning. KPI ökar alltså över tid. 

# Slutsats av tidsseriedata
KPI ökar över tiden. Detta förklarar sig självt av en generellt konstant positiv inflation. Det kan eventuellt föreligga någon typ av säsongsvariation. Detta då det högsta medelvärdet för KPI förekommer i december månad. Och lägsta förekommer i januari. Detta skulle givetvis också enkelt nog kunna förklaras av det faktum att januari är den första månaden varje år och december sista. Med en positiv inflation så kommer det ganska självklart innebära högre KPI i genomsnitt mot slutet av året. 